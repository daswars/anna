{{/*
  Responsive Image Partial

  Usage:
    {{ partial "responsive-image.html" (dict
      "src" "/images/paintings/2022/painting.jpg"
      "alt" "Artwork title"
      "class" "optional-css-classes"
      "sizes" "(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
      "loading" "lazy"
    ) }}

  Generates:
    - Multiple sizes (400w, 800w, 1200w, original)
    - WebP format with JPEG fallback
    - srcset for responsive loading
    - Native lazy loading
*/}}

{{- $src := .src -}}
{{- $alt := .alt | default "" -}}
{{- $class := .class | default "" -}}
{{- $sizes := .sizes | default "(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw" -}}
{{- $loading := .loading | default "lazy" -}}

{{/* Convert /images/ path to assets path */}}
{{- $assetPath := replace $src "/images/" "images/" -}}

{{/* Get the image resource */}}
{{- $image := resources.Get $assetPath -}}

{{- if $image -}}
  {{/* Define resize widths */}}
  {{- $widths := slice 400 800 1200 -}}

  {{/* Generate WebP srcset */}}
  {{- $webpSrcset := slice -}}
  {{- $jpegSrcset := slice -}}

  {{- range $widths -}}
    {{- $width := . -}}
    {{/* Only resize if image is larger than target width */}}
    {{- if gt $image.Width $width -}}
      {{- $resized := $image.Resize (printf "%dx webp q85" $width) -}}
      {{- $webpSrcset = $webpSrcset | append (printf "%s %dw" $resized.RelPermalink $width) -}}

      {{- $resizedJpeg := $image.Resize (printf "%dx jpg q85" $width) -}}
      {{- $jpegSrcset = $jpegSrcset | append (printf "%s %dw" $resizedJpeg.RelPermalink $width) -}}
    {{- end -}}
  {{- end -}}

  {{/* Add original size to srcset (resized to avoid copying raw originals) */}}
  {{- $originalWebp := $image.Resize (printf "%dx webp q85" $image.Width) -}}
  {{- $originalJpeg := $image.Resize (printf "%dx jpg q85" $image.Width) -}}
  {{- $webpSrcset = $webpSrcset | append (printf "%s %dw" $originalWebp.RelPermalink $image.Width) -}}
  {{- $jpegSrcset = $jpegSrcset | append (printf "%s %dw" $originalJpeg.RelPermalink $image.Width) -}}

  {{/* Generate small placeholder for blur-up effect */}}
  {{- $placeholder := $image.Resize "20x webp q20" -}}

  <picture>
    {{/* WebP source */}}
    <source
      type="image/webp"
      srcset="{{ delimit $webpSrcset ", " }}"
      sizes="{{ $sizes }}"
    >
    {{/* JPEG fallback */}}
    <source
      type="image/jpeg"
      srcset="{{ delimit $jpegSrcset ", " }}"
      sizes="{{ $sizes }}"
    >
    {{/* Fallback img - use optimized WebP version */}}
    <img
      src="{{ $originalWebp.RelPermalink }}"
      alt="{{ $alt }}"
      width="{{ $image.Width }}"
      height="{{ $image.Height }}"
      loading="{{ $loading }}"
      decoding="async"
      {{ with $class }}class="{{ . }}"{{ end }}
      style="background-image: url('{{ $placeholder.RelPermalink }}'); background-size: cover;"
    >
  </picture>
{{- else -}}
  {{/* Fallback if image not found */}}
  <img src="{{ $src }}" alt="{{ $alt }}" {{ with $class }}class="{{ . }}"{{ end }} loading="{{ $loading }}">
{{- end -}}
