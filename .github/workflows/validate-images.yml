name: validate-images

# Wird bei jedem PR ausgef√ºhrt der Bilder enth√§lt
on:
  pull_request:
    paths:
      - 'assets/images/**'
      - 'data/paintings.yaml'
      - 'data/sculptures.yaml'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      # =========================================
      # STEP 1: Dateinamen-Validierung
      # =========================================
      - name: "Step 1: Validate filenames"
        id: validate-filenames
        run: |
          echo "üîç Validiere Dateinamen..."
          errors=0

          # Paintings
          for file in assets/images/paintings/**/*.{jpg,jpeg,png}; do
            [[ -f "$file" ]] || continue
            basename=$(basename "$file")

            if [[ ! "$basename" =~ ^painting-[0-9]{4}-[0-9]{3}-[a-z0-9-]+\.(jpg|jpeg|png)$ ]]; then
              echo "‚ùå Ung√ºltiger Dateiname: $basename"
              echo "   Erwartet: painting-YYYY-NNN-slug.jpg"
              ((errors++))
            fi
          done

          # Sculptures
          for file in assets/images/sculptures/*.{jpg,jpeg,png}; do
            [[ -f "$file" ]] || continue
            basename=$(basename "$file")

            if [[ ! "$basename" =~ ^sculpture-[0-9]{4}-[0-9]{3}-[a-z0-9-]+\.(jpg|jpeg|png)$ ]]; then
              echo "‚ùå Ung√ºltiger Dateiname: $basename"
              echo "   Erwartet: sculpture-YYYY-NNN-slug.jpg"
              ((errors++))
            fi
          done

          if [[ $errors -eq 0 ]]; then
            echo "‚úÖ Alle Dateinamen sind korrekt"
          else
            echo "::error::$errors Dateinamen-Fehler gefunden"
            exit 1
          fi

      # =========================================
      # STEP 2: Bildformat validieren
      # =========================================
      - name: "Step 2: Validate image formats"
        id: validate-formats
        run: |
          echo "üîç Validiere Bildformate..."
          errors=0

          for file in assets/images/paintings/**/*.{jpg,jpeg,png} assets/images/sculptures/*.{jpg,jpeg,png}; do
            [[ -f "$file" ]] || continue

            format=$(identify -format "%m" "$file" 2>/dev/null || echo "UNKNOWN")
            if [[ "$format" != "JPEG" && "$format" != "PNG" ]]; then
              echo "‚ùå Ung√ºltiges Format: $file ($format)"
              echo "   Erwartet: JPEG oder PNG"
              ((errors++))
            fi
          done

          if [[ $errors -eq 0 ]]; then
            echo "‚úÖ Alle Bilder haben g√ºltiges Format (JPEG/PNG)"
          else
            echo "::error::$errors Format-Fehler gefunden"
            exit 1
          fi

      # =========================================
      # STEP 3: YAML-Syntax validieren
      # =========================================
      - name: "Step 3: Validate YAML syntax"
        id: validate-yaml
        run: |
          echo "üîç Validiere YAML-Syntax..."

          python3 << 'EOF'
          import yaml
          import sys

          files = ['data/paintings.yaml', 'data/sculptures.yaml', 'data/exhibitions.yaml']
          errors = 0

          for f in files:
              try:
                  with open(f) as file:
                      yaml.safe_load(file)
                  print(f"‚úÖ {f}")
              except yaml.YAMLError as e:
                  print(f"‚ùå {f}: {e}")
                  errors += 1
              except FileNotFoundError:
                  print(f"‚ö†Ô∏è {f} nicht gefunden (optional)")

          sys.exit(errors)
          EOF

      # =========================================
      # STEP 4: Zweisprachigkeit pr√ºfen
      # =========================================
      - name: "Step 4: Validate bilingual fields"
        id: validate-bilingual
        run: |
          echo "üîç Validiere Zweisprachigkeit..."

          python3 << 'EOF'
          import yaml
          import sys

          errors = 0

          # Paintings
          try:
              with open('data/paintings.yaml') as f:
                  data = yaml.safe_load(f)

              for item in data.get('paintings', []):
                  item_id = item.get('id', 'unknown')

                  # Pr√ºfe ob beide Sprachfelder existieren
                  if 'title_de' not in item:
                      print(f"‚ùå {item_id}: title_de fehlt")
                      errors += 1
                  if 'title_en' not in item:
                      print(f"‚ùå {item_id}: title_en fehlt")
                      errors += 1
                  if 'medium_de' not in item:
                      print(f"‚ùå {item_id}: medium_de fehlt")
                      errors += 1
                  if 'medium_en' not in item:
                      print(f"‚ùå {item_id}: medium_en fehlt")
                      errors += 1

                  # Pr√ºfe Konsistenz: o.T. -> Untitled
                  title_de = item.get('title_de', '')
                  title_en = item.get('title_en', '')
                  if title_de in ['o.T.', 'ohne Titel', 'Ohne Titel']:
                      if title_en != 'Untitled':
                          print(f"‚ö†Ô∏è {item_id}: '{title_de}' sollte 'Untitled' sein, nicht '{title_en}'")

          except Exception as e:
              print(f"‚ùå Fehler beim Parsen von paintings.yaml: {e}")
              errors += 1

          # Sculptures
          try:
              with open('data/sculptures.yaml') as f:
                  data = yaml.safe_load(f)

              for item in data.get('sculptures', []):
                  item_id = item.get('id', 'unknown')

                  if 'title_de' not in item:
                      print(f"‚ùå {item_id}: title_de fehlt")
                      errors += 1
                  if 'title_en' not in item:
                      print(f"‚ùå {item_id}: title_en fehlt")
                      errors += 1

          except Exception as e:
              print(f"‚ùå Fehler beim Parsen von sculptures.yaml: {e}")
              errors += 1

          if errors == 0:
              print("‚úÖ Alle zweisprachigen Felder vorhanden")
          else:
              print(f"::error::{errors} Zweisprachigkeits-Fehler gefunden")
              sys.exit(1)
          EOF

      # =========================================
      # STEP 5: Bild-Referenzen in YAML pr√ºfen
      # =========================================
      - name: "Step 5: Validate image references"
        id: validate-references
        run: |
          echo "üîç Validiere Bild-Referenzen in YAML..."
          echo "‚ÑπÔ∏è  Hinweis: Thumbnails werden von Hugo automatisch generiert"

          python3 << 'EOF'
          import yaml
          import os
          import sys

          errors = 0

          # Paintings
          try:
              with open('data/paintings.yaml') as f:
                  data = yaml.safe_load(f)

              for item in data.get('paintings', []):
                  item_id = item.get('id', 'unknown')
                  image = item.get('image', '')

                  # Konvertiere URL-Pfad zu assets-Pfad
                  # /images/paintings/... -> assets/images/paintings/...
                  if image:
                      image_path = 'assets' + image
                      if not os.path.exists(image_path):
                          print(f"‚ùå {item_id}: Bild nicht gefunden: {image_path}")
                          errors += 1

                  # Warnung wenn thumbnail-Feld noch existiert (veraltet)
                  if 'thumbnail' in item:
                      print(f"‚ö†Ô∏è {item_id}: thumbnail-Feld ist veraltet (Hugo generiert automatisch)")

          except Exception as e:
              print(f"‚ùå Fehler beim Pr√ºfen von paintings.yaml: {e}")
              errors += 1

          # Sculptures
          try:
              with open('data/sculptures.yaml') as f:
                  data = yaml.safe_load(f)

              for item in data.get('sculptures', []):
                  item_id = item.get('id', 'unknown')
                  image = item.get('image', '')

                  if image:
                      image_path = 'assets' + image
                      if not os.path.exists(image_path):
                          print(f"‚ùå {item_id}: Bild nicht gefunden: {image_path}")
                          errors += 1

                  # Warnung wenn thumbnail-Feld noch existiert (veraltet)
                  if 'thumbnail' in item:
                      print(f"‚ö†Ô∏è {item_id}: thumbnail-Feld ist veraltet (Hugo generiert automatisch)")

          except Exception as e:
              print(f"‚ùå Fehler beim Pr√ºfen von sculptures.yaml: {e}")
              errors += 1

          if errors == 0:
              print("‚úÖ Alle Bild-Referenzen g√ºltig")
          else:
              print(f"::error::{errors} fehlende Bilder")
              sys.exit(1)
          EOF

      # =========================================
      # Zusammenfassung
      # =========================================
      - name: "Summary"
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "       VALIDIERUNGS-ZUSAMMENFASSUNG"
          echo "========================================"
          echo "1. Dateinamen:        ${{ steps.validate-filenames.outcome }}"
          echo "2. Bildformate:       ${{ steps.validate-formats.outcome }}"
          echo "3. YAML-Syntax:       ${{ steps.validate-yaml.outcome }}"
          echo "4. Zweisprachigkeit:  ${{ steps.validate-bilingual.outcome }}"
          echo "5. Bild-Referenzen:   ${{ steps.validate-references.outcome }}"
          echo "========================================"
          echo ""
          echo "‚ÑπÔ∏è  Hugo Image Processing:"
          echo "   - Thumbnails werden beim Build automatisch generiert"
          echo "   - Bilder m√ºssen in assets/images/ liegen"
          echo "   - Kein manuelles thumbnail-Feld in YAML n√∂tig"
          echo "========================================"
